import{Q as h}from"./QSpace-CRJFh_fq.js";import{_ as S,c as x,o as p,w as a,b as l,a as t,Q as v,e as m,f as d,af as u,d as V,a9 as y,aa as w,ab as q,ac as k,t as i,a8 as g,h as D,ah as Q}from"./index-D17d9CED.js";import{Q as U}from"./QBadge-CfV2PV27.js";import{c as B,Q as N,b as _,a as C}from"./QList-DtAzkZzK.js";import{Q as A}from"./QPage-Mqie5rLH.js";const I={name:"ComprasAlmacenForm",data(){const r=new Date().toISOString().substr(0,10);return{loading:!1,search:"",almacenes:[],carrito:[],qtyDlg:!1,current:null,form:{cantidad:null,costo:null},payDlg:!1,compra:{fecha:r,proveedor:"",nota:""}}},computed:{filteredAlmacenes(){const r=(this.search||"").toLowerCase();return r?this.almacenes.filter(e=>String(e.nombre||"").toLowerCase().includes(r)||String(e.unidad||"").toLowerCase().includes(r)||String(e.descripcion||"").toLowerCase().includes(r)):this.almacenes},total(){return this.carrito.reduce((r,e)=>{const c=Number(e.cantidad||0),b=Number(e.costo||0);return r+c*b},0)}},mounted(){this.almacenesGet()},methods:{to2(r){return Number(r||0).toLocaleString("es-BO",{minimumFractionDigits:2,maximumFractionDigits:2})},money(r){return this.to2(r)},async almacenesGet(){this.loading=!0;try{const r=await this.$axios.get("almacenes");this.almacenes=Array.isArray(r.data)?r.data:[]}catch{this.$alert?.error?.("No se pudo cargar los insumos de almacén")}finally{this.loading=!1}},openQtyDialog(r){this.current=r,this.form={cantidad:1,costo:Number(r.costo||0)},this.addToCart()},addToCart(){const r=Number(this.form.cantidad||0),e=Number(this.form.costo||0),c=this.carrito.findIndex(b=>b.id===this.current.id);c>=0?(this.carrito[c].cantidad+=r,this.carrito[c].costo=e):this.carrito.push({id:this.current.id,nombre:this.current.nombre,unidad:this.current.unidad,cantidad:r,costo:e}),this.qtyDlg=!1},removeFromCart(r){this.carrito=this.carrito.filter(e=>e.id!==r)},clearCart(){this.carrito=[]},openPayDialog(){if(!this.carrito.length){this.$alert?.error?.("Carrito vacío");return}this.payDlg=!0},async savePurchase(){const r={fecha:this.compra.fecha,proveedor:this.compra.proveedor||null,nota:this.compra.nota||null,detalles:this.carrito.map(e=>({almacen_id:e.id,cantidad:Number(e.cantidad||0),costo:Number(e.costo||0)}))};this.loading=!0;try{await this.$axios.post("compras-almacen",r),this.$alert?.success?.("Compra de almacén registrada"),this.payDlg=!1,this.carrito=[],this.compra.proveedor="",this.compra.nota="",this.almacenesGet()}catch(e){const c=e.response?.data?.message||"No se pudo registrar la compra";this.$alert?.error?.(c)}finally{this.loading=!1}}}},L={class:"row q-col-gutter-sm"},F={class:"col-12 col-md-8"},P={class:"row items-center q-col-gutter-sm"},T={class:"col-12 col-md-6"},G={class:"col-12 col-md-6 text-right"},M={class:"q-mt-sm"},O=["onClick"],z={class:"row items-center q-px-sm q-py-xs"},E={class:"col-8"},R={class:"text-body1 text-weight-medium"},j={class:"text-caption text-grey"},H={class:"col-4 text-right"},J={key:0,class:"q-mt-md text-center text-grey"},K={class:"col-12 col-md-4"},W={class:"row q-col-gutter-xs q-mt-xs"},X={class:"col-6"},Y={class:"col-6"},Z={class:"text-bold text-primary"},$={class:"q-mt-sm text-right text-subtitle1"},ee={class:"text-subtitle1"},te={class:"text-caption q-mb-xs"},oe={class:"row q-col-gutter-sm"},le={class:"col-12 col-sm-6"},se={class:"col-12 col-sm-6"},ae={class:"col-12"},re={class:"q-mt-sm text-right text-subtitle1"};function ne(r,e,c,b,s,n){return p(),x(A,{class:"bg-grey-3 q-pa-sm"},{default:a(()=>[l("div",L,[l("div",F,[t(v,{flat:"",bordered:""},{default:a(()=>[t(m,{class:"q-pa-sm bg-blue-1 row items-center"},{default:a(()=>[e[12]||(e[12]=l("div",{class:"text-subtitle1 text-weight-bold"},"Insumos de almacén",-1)),t(h),t(d,{flat:"",dense:"",color:"primary",icon:"arrow_back",label:"Volver a listado","no-caps":"",to:{path:"/compras-almacen"}})]),_:1}),t(m,{class:"q-pa-sm"},{default:a(()=>[l("div",P,[l("div",T,[t(u,{modelValue:s.search,"onUpdate:modelValue":e[0]||(e[0]=o=>s.search=o),dense:"",outlined:"",placeholder:"Buscar (nombre, unidad, descripción)"},{prepend:a(()=>[t(V,{name:"search"})]),_:1},8,["modelValue"])]),l("div",G,[t(d,{flat:"",color:"primary",icon:"refresh",loading:s.loading,onClick:n.almacenesGet,label:"Actualizar","no-caps":""},null,8,["loading","onClick"])])]),l("div",M,[e[14]||(e[14]=l("div",{class:"row text-grey-7 q-pb-xs"},[l("div",{class:"col-8 text-caption text-weight-bold"},"Insumo"),l("div",{class:"col-4 text-right text-caption text-weight-bold"},"Stock")],-1)),(p(!0),y(q,null,k(n.filteredAlmacenes,o=>(p(),y("div",{key:o.id,class:"q-py-xs q-mb-xs bg-grey-1 rounded-borders cursor-pointer",onClick:f=>n.openQtyDialog(o)},[l("div",z,[l("div",E,[l("div",R,i(o.nombre),1),l("div",j,i(o.unidad)+" — "+i(o.descripcion||"—"),1)]),l("div",H,[t(U,{color:"primary","text-color":"white",align:"middle"},{default:a(()=>[g(i(n.to2(o.stock))+" "+i(o.unidad),1)]),_:2},1024)])])],8,O))),128)),n.filteredAlmacenes.length?w("",!0):(p(),y("div",J,[t(V,{name:"inventory_2"}),e[13]||(e[13]=l("div",{class:"text-caption"},"Sin insumos de almacén para mostrar",-1))]))])]),_:1})]),_:1})]),l("div",K,[t(v,{flat:"",bordered:""},{default:a(()=>[t(m,{class:"q-pa-sm bg-amber-1 row items-center"},{default:a(()=>[e[15]||(e[15]=l("div",{class:"text-subtitle1 text-bold"},"Carrito de compra",-1)),t(h),t(d,{dense:"",flat:"",color:"red",icon:"delete_sweep",label:"Limpiar","no-caps":"",onClick:n.clearCart},null,8,["onClick"])]),_:1}),t(m,{class:"q-pa-sm"},{default:a(()=>[t(B,{bordered:"",dense:"",class:"rounded-borders"},{default:a(()=>[(p(!0),y(q,null,k(s.carrito,o=>(p(),x(N,{key:o.id},{default:a(()=>[t(_,null,{default:a(()=>[t(C,{class:"text-bold"},{default:a(()=>[g(i(o.nombre),1)]),_:2},1024),t(C,{caption:""},{default:a(()=>[l("div",W,[l("div",X,[t(u,{modelValue:o.cantidad,"onUpdate:modelValue":f=>o.cantidad=f,modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Cantidad"},null,8,["modelValue","onUpdate:modelValue"])]),l("div",Y,[t(u,{modelValue:o.costo,"onUpdate:modelValue":f=>o.costo=f,modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Costo (Bs)"},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024),t(_,{side:"",class:"text-right"},{default:a(()=>[l("div",Z,i(n.money(o.cantidad*o.costo)),1),t(d,{dense:"",flat:"",round:"",icon:"delete",color:"red",onClick:f=>n.removeFromCart(o.id)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128)),s.carrito.length?w("",!0):(p(),x(N,{key:0},{default:a(()=>[t(_,null,{default:a(()=>[t(C,{caption:""},{default:a(()=>[...e[16]||(e[16]=[g("Carrito vacío",-1)])]),_:1})]),_:1})]),_:1}))]),_:1}),l("div",$,[e[17]||(e[17]=l("b",null,"Total:",-1)),g(" "+i(n.money(n.total))+" Bs ",1)]),t(d,{class:"q-mt-md full-width",color:"indigo",icon:"shopping_cart",label:"Registrar compra",disable:!s.carrito.length,loading:s.loading,"no-caps":"",onClick:n.openPayDialog},null,8,["disable","loading","onClick"])]),_:1})]),_:1})])]),t(D,{modelValue:s.qtyDlg,"onUpdate:modelValue":e[5]||(e[5]=o=>s.qtyDlg=o)},{default:a(()=>[t(v,{style:{width:"420px","max-width":"90vw"}},{default:a(()=>[t(m,{class:"row items-center q-pb-none"},{default:a(()=>[l("div",ee,"Agregar: "+i(s.current?.nombre),1),t(h),t(d,{flat:"",round:"",dense:"",icon:"close",onClick:e[1]||(e[1]=o=>s.qtyDlg=!1)})]),_:1}),t(m,{class:"q-pt-none"},{default:a(()=>[l("div",te," Unidad: "+i(s.current?.unidad)+" | Stock actual: "+i(n.to2(s.current?.stock)),1),t(u,{modelValue:s.form.cantidad,"onUpdate:modelValue":e[2]||(e[2]=o=>s.form.cantidad=o),modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Cantidad",class:"q-mb-sm"},null,8,["modelValue"]),t(u,{modelValue:s.form.costo,"onUpdate:modelValue":e[3]||(e[3]=o=>s.form.costo=o),modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Costo (Bs)"},null,8,["modelValue"])]),_:1}),t(Q,{align:"right"},{default:a(()=>[t(d,{flat:"",label:"Cancelar",color:"negative","no-caps":"",onClick:e[4]||(e[4]=o=>s.qtyDlg=!1)}),t(d,{label:"Agregar",color:"primary","no-caps":"",onClick:n.addToCart},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(D,{modelValue:s.payDlg,"onUpdate:modelValue":e[11]||(e[11]=o=>s.payDlg=o)},{default:a(()=>[t(v,{style:{width:"540px","max-width":"95vw"}},{default:a(()=>[t(m,{class:"row items-center q-pb-none"},{default:a(()=>[e[18]||(e[18]=l("div",{class:"text-subtitle1"},"Confirmar compra de almacén",-1)),t(h),t(d,{flat:"",round:"",dense:"",icon:"close",onClick:e[6]||(e[6]=o=>s.payDlg=!1)})]),_:1}),t(m,{class:"q-pt-none"},{default:a(()=>[l("div",oe,[l("div",le,[t(u,{modelValue:s.compra.fecha,"onUpdate:modelValue":e[7]||(e[7]=o=>s.compra.fecha=o),label:"Fecha",type:"date",dense:"",outlined:""},null,8,["modelValue"])]),l("div",se,[t(u,{modelValue:s.compra.proveedor,"onUpdate:modelValue":e[8]||(e[8]=o=>s.compra.proveedor=o),label:"Proveedor",dense:"",outlined:""},null,8,["modelValue"])]),l("div",ae,[t(u,{modelValue:s.compra.nota,"onUpdate:modelValue":e[9]||(e[9]=o=>s.compra.nota=o),label:"Nota",type:"textarea",autogrow:"",dense:"",outlined:""},null,8,["modelValue"])])]),l("div",re,[e[19]||(e[19]=l("b",null,"Total:",-1)),g(" "+i(n.money(n.total))+" Bs ",1)])]),_:1}),t(Q,{align:"right"},{default:a(()=>[t(d,{flat:"",color:"negative",label:"Cancelar","no-caps":"",onClick:e[10]||(e[10]=o=>s.payDlg=!1)}),t(d,{color:"positive",label:"Guardar","no-caps":"",loading:s.loading,onClick:n.savePurchase},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const pe=S(I,[["render",ne]]);export{pe as default};
