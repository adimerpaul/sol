import{_ as E,c as n,o as i,w as a,a as s,b as h,a9 as w,aa as P,ab as D,ac as U,a8 as f,t as b,ae as I,d as g,P as y,f as d,af as v,h as q,Q as _,e as k,ag as S,ah as B}from"./index-D17d9CED.js";import{c as G,Q as C,b as m,a as V}from"./QList-DtAzkZzK.js";import{Q as T}from"./QBtnDropdown-DZ9Zwjea.js";import{Q as x}from"./QTd-D0V8Af-v.js";import{Q as F}from"./format-C2NjPuPn.js";import{Q as L}from"./QImg-ngmdXLJc.js";import{Q as O}from"./QTooltip-BM3pJKYk.js";import{Q as N}from"./QBadge-CfV2PV27.js";import{Q as R}from"./QTable-ndNxYlyN.js";import{Q as A}from"./QSpace-CRJFh_fq.js";import{Q as j}from"./QSelect-CvCEXiBv.js";import{Q as z}from"./QForm-DCBzBiBo.js";import{Q as H}from"./QPage-Mqie5rLH.js";import{C as Q}from"./ClosePopup-DI1WlcTZ.js";import"./moment-BLMuvzoS.js";import"./position-engine-DqQ8RByf.js";const J={name:"UsuariosPage",data(){return{users:[],user:{},userDialog:!1,loading:!1,actionUser:"",gestiones:[],filter:"",roles:["Administrador","Vendedor"],columns:[{name:"actions",label:"Acciones",align:"center"},{name:"name",label:"Nombre",align:"left",field:"name"},{name:"username",label:"Usuario",align:"left",field:"username"},{name:"avatar",label:"Avatar",align:"left",field:r=>r.avatar},{name:"role",label:"Rol",align:"left",field:"role"},{name:"permissions",label:"Permisos",align:"left",field:r=>(r.permissions||[]).map(e=>e.name).join(", ")}],permissions:[],dialogPermisos:!1,permFilter:"",cambioAvatarDialogo:!1,docentes:[]}},async mounted(){this.usersGet()},methods:{onFileChange(r){const e=r.target.files[0],c=new FormData;c.append("avatar",e),this.loading=!0,this.$axios.post(this.user.id+"/avatar",c,{headers:{"Content-Type":"multipart/form-data"}}).then(p=>{this.cambioAvatarDialogo=!1,this.$alert.success("Avatar actualizado"),this.usersGet()}).catch(p=>{this.$alert.error(p.response.data.message)}).finally(()=>{this.loading=!1})},cambiarAvatar(r){this.cambioAvatarDialogo=!0,this.user={...r}},userNew(){this.user={name:"",email:"",password:"",area_id:1,username:"",cargo:"",role:"Vendedor"},this.actionUser="Nuevo",this.userDialog=!0},usersGet(){this.loading=!0,this.users=[],this.$axios.get("users").then(r=>{this.users=r.data}).catch(r=>{this.$alert.error(r.response.data.message)}).finally(()=>{this.loading=!1})},gestionGet(){this.loading=!0,this.$axios.get("gestiones").then(r=>{this.gestiones=r.data,this.loading=!1}).catch(r=>{this.$alert.error(r.response.data.message),this.loading=!1})},userPost(){this.loading=!0,this.$axios.post("users",this.user).then(r=>{this.userDialog=!1,this.$alert.success("User creado"),this.usersGet()}).catch(r=>{this.$alert.error(r.response.data.message)}).finally(()=>{this.loading=!1})},userPut(){this.loading=!0,this.$axios.put("users/"+this.user.id,this.user).then(r=>{this.usersGet(),this.userDialog=!1,this.$alert.success("User actualizado")}).catch(r=>{this.$alert.error(r.response.data.message)}).finally(()=>{this.loading=!1})},async permisosShow(r){this.user={...r},this.dialogPermisos=!0,this.loading=!0;try{const e=await this.$axios.get("permissions").then(p=>p.data),c=await this.$axios.get(`users/${r.id}/permissions`).then(p=>p.data);this.permissions=e.map(p=>({...p,checked:c.includes(p.id)}))}catch(e){this.$alert.error(e.response?.data?.message||"Error cargando permisos")}finally{this.loading=!1}},async permisosPost(){this.loading=!0;try{const r=this.permissions.filter(e=>e.checked).map(e=>e.id);await this.$axios.put(`users/${this.user.id}/permissions`,{permissions:r}),this.dialogPermisos=!1,this.$alert.success("Permisos actualizados"),this.usersGet()}catch(r){this.$alert.error(r.response?.data?.message||"No se pudo guardar")}finally{this.loading=!1}},userEditPassword(r){this.user={...r},this.$alert.dialogPrompt("Nueva contraseña","Ingrese la nueva contraseña","password").onOk(e=>{this.$axios.put("updatePassword/"+r.id,{password:e}).then(c=>{this.usersGet(),this.$alert.success("Contraseña actualizada de "+r.username)}).catch(c=>{this.$alert.error(c.response.data.message)})})},userEdit(r){this.user={...r},this.actionUser="Editar",this.userDialog=!0},userDelete(r){this.$alert.dialog("¿Desea eliminar el user?").onOk(()=>{this.loading=!0,this.$axios.delete("users/"+r).then(e=>{this.usersGet(),this.$alert.success("User eliminado")}).catch(e=>{this.$alert.error(e.response.data.message)}).finally(()=>{this.loading=!1})})}},computed:{filteredPermissions(){if(!this.permFilter)return this.permissions;const r=this.permFilter.toLowerCase();return this.permissions.filter(e=>e.name.toLowerCase().includes(r))}}},K={class:"row items-center q-col-gutter-xs"},M={class:"text-left"},W={class:"text-right"},X={style:{position:"relative",top:"0",left:"0"}},Y=["src"],Z={class:"text-right"};function $(r,e,c,p,o,t){return i(),n(H,{class:"q-pa-md"},{default:a(()=>[s(R,{rows:o.users,columns:o.columns,dense:"","wrap-cells":"",flat:"",bordered:"","rows-per-page-options":[0],title:"Usuarios",filter:o.filter},{"top-right":a(()=>[s(d,{color:"positive",label:"Nuevo",onClick:t.userNew,"no-caps":"",icon:"add_circle_outline",loading:o.loading,class:"q-mr-sm"},null,8,["onClick","loading"]),s(d,{color:"primary",label:"Actualizar",onClick:t.usersGet,"no-caps":"",icon:"refresh",loading:o.loading},null,8,["onClick","loading"]),s(v,{modelValue:o.filter,"onUpdate:modelValue":e[0]||(e[0]=l=>o.filter=l),label:"Buscar",dense:"",outlined:""},{append:a(()=>[s(g,{name:"search"})]),_:1},8,["modelValue"])]),"body-cell-actions":a(l=>[s(x,{props:l},{default:a(()=>[s(T,{label:"Opciones","no-caps":"",size:"10px",dense:"",color:"primary"},{default:a(()=>[s(G,null,{default:a(()=>[y((i(),n(C,{clickable:"",onClick:u=>t.userEdit(l.row)},{default:a(()=>[s(m,{avatar:""},{default:a(()=>[s(g,{name:"edit"})]),_:1}),s(m,null,{default:a(()=>[s(V,null,{default:a(()=>[...e[20]||(e[20]=[f("Editar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[Q]]),y((i(),n(C,{clickable:"",onClick:u=>t.userDelete(l.row.id)},{default:a(()=>[s(m,{avatar:""},{default:a(()=>[s(g,{name:"delete"})]),_:1}),s(m,null,{default:a(()=>[s(V,null,{default:a(()=>[...e[21]||(e[21]=[f("Eliminar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[Q]]),y((i(),n(C,{clickable:"",onClick:u=>t.userEditPassword(l.row)},{default:a(()=>[s(m,{avatar:""},{default:a(()=>[s(g,{name:"lock_reset"})]),_:1}),s(m,null,{default:a(()=>[s(V,null,{default:a(()=>[...e[22]||(e[22]=[f("Cambiar contraseña",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[Q]]),y((i(),n(C,{clickable:"",onClick:u=>t.cambiarAvatar(l.row)},{default:a(()=>[s(m,{avatar:""},{default:a(()=>[s(g,{name:"image"})]),_:1}),s(m,null,{default:a(()=>[s(V,null,{default:a(()=>[...e[23]||(e[23]=[f("Cambiar avatar",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[Q]]),y((i(),n(C,{clickable:"",onClick:u=>t.permisosShow(l.row)},{default:a(()=>[s(m,{avatar:""},{default:a(()=>[s(g,{name:"lock"})]),_:1}),s(m,null,{default:a(()=>[s(V,null,{default:a(()=>[...e[24]||(e[24]=[f("Permisos",-1)])]),_:1})]),_:1})]),_:1},8,["onClick"])),[[Q]])]),_:2},1024)]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-role":a(l=>[s(x,{props:l},{default:a(()=>[s(F,{label:l.row.role,color:r.$filters.color(l.row.role),"text-color":"white",dense:"",size:"14px"},null,8,["label","color"])]),_:2},1032,["props"])]),"body-cell-avatar":a(l=>[s(x,{props:l},{default:a(()=>[s(I,{rounded:""},{default:a(()=>[l.row.avatar?(i(),n(L,{key:0,src:`${r.$url}/../images/${l.row.avatar}`,width:"40px",height:"40px"},null,8,["src"])):(i(),n(g,{key:1,name:"person",size:"40px"}))]),_:2},1024)]),_:2},1032,["props"])]),"body-cell-permissions":a(l=>[s(x,{props:l},{default:a(()=>[h("div",K,[(i(!0),w(D,null,U((l.row.permissions||[]).slice(0,3),(u,ee)=>(i(),n(F,{key:u.id,dense:"",color:"grey-3","text-color":"black",size:"12px",class:"q-mr-xs q-mb-xs"},{default:a(()=>[f(b(u.name),1)]),_:2},1024))),128)),(l.row.permissions||[]).length>3?(i(),n(N,{key:0,outline:"",color:"primary",class:"q-ml-xs"},{default:a(()=>[f(" +"+b((l.row.permissions||[]).length-3)+" ",1),s(O,{anchor:"top middle",self:"bottom middle",offset:[0,8]},{default:a(()=>[h("div",M,[(i(!0),w(D,null,U(l.row.permissions,u=>(i(),w("div",{key:u.id},"• "+b(u.name),1))),128))])]),_:2},1024)]),_:2},1024)):P("",!0),(l.row.permissions||[]).length?P("",!0):(i(),n(N,{key:1,color:"grey-5","text-color":"white",outline:""},{default:a(()=>[...e[25]||(e[25]=[f(" Sin permisos ",-1)])]),_:1}))])]),_:2},1032,["props"])]),_:1},8,["rows","columns","filter"]),s(q,{modelValue:o.userDialog,"onUpdate:modelValue":e[9]||(e[9]=l=>o.userDialog=l),persistent:""},{default:a(()=>[s(_,{style:{width:"400px"}},{default:a(()=>[s(k,{class:"q-pb-none row items-center"},{default:a(()=>[h("div",null,b(o.actionUser)+" user ",1),s(A),s(d,{icon:"close",flat:"",round:"",dense:"",onClick:e[1]||(e[1]=l=>o.userDialog=!1)})]),_:1}),s(k,{class:"q-pt-none"},{default:a(()=>[s(z,{onSubmit:e[8]||(e[8]=l=>o.user.id?t.userPut():t.userPost())},{default:a(()=>[s(v,{modelValue:o.user.name,"onUpdate:modelValue":e[2]||(e[2]=l=>o.user.name=l),label:"Nombre",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"]),s(v,{modelValue:o.user.username,"onUpdate:modelValue":e[3]||(e[3]=l=>o.user.username=l),label:"Usuario",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"]),s(v,{modelValue:o.user.email,"onUpdate:modelValue":e[4]||(e[4]=l=>o.user.email=l),label:"Email",dense:"",outlined:"",hint:""},null,8,["modelValue"]),o.user.id?P("",!0):(i(),n(v,{key:0,modelValue:o.user.password,"onUpdate:modelValue":e[5]||(e[5]=l=>o.user.password=l),label:"Contraseña",dense:"",outlined:"",rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","rules"])),s(j,{modelValue:o.user.role,"onUpdate:modelValue":e[6]||(e[6]=l=>o.user.role=l),label:"Rol",dense:"",outlined:"",options:o.roles,rules:[l=>!!l||"Campo requerido"]},null,8,["modelValue","options","rules"]),h("div",W,[s(d,{color:"negative",label:"Cancelar",onClick:e[7]||(e[7]=l=>o.userDialog=!1),"no-caps":"",loading:o.loading},null,8,["loading"]),s(d,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:o.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(q,{modelValue:o.cambioAvatarDialogo,"onUpdate:modelValue":e[15]||(e[15]=l=>o.cambioAvatarDialogo=l),persistent:""},{default:a(()=>[s(_,null,{default:a(()=>[s(k,{class:"q-pb-none row items-center text-bold"},{default:a(()=>[e[26]||(e[26]=f(" Cambiar avatar ",-1)),s(A),s(d,{icon:"close",flat:"",round:"",dense:"",onClick:e[10]||(e[10]=l=>o.cambioAvatarDialogo=!1)})]),_:1}),s(k,{class:"q-pt-none"},{default:a(()=>[s(z,{onSubmit:e[14]||(e[14]=l=>t.userPut())},{default:a(()=>[h("div",null,[h("div",X,[s(d,{icon:"edit",size:"10px",class:"absolute q-mt-sm q-ml-sm",onClick:e[11]||(e[11]=l=>r.$refs.fileInput.click()),dense:"",outline:"",label:"Cambiar foto","no-caps":""})]),o.user.avatar?(i(),w("img",{key:0,src:`${r.$url}/../images/${o.user.avatar}`,width:"300px",height:"300px"},null,8,Y)):(i(),n(g,{key:1,name:"person",size:"100px"})),h("input",{ref:"fileInput",type:"file",style:{display:"none"},onChange:e[12]||(e[12]=(...l)=>t.onFileChange&&t.onFileChange(...l)),accept:"image/*"},null,544)]),h("div",Z,[s(d,{color:"negative",label:"Cancelar",onClick:e[13]||(e[13]=l=>o.cambioAvatarDialogo=!1),"no-caps":"",loading:o.loading},null,8,["loading"]),s(d,{color:"primary",label:"Guardar",type:"submit","no-caps":"",loading:o.loading,class:"q-ml-sm"},null,8,["loading"])])]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"]),s(q,{modelValue:o.dialogPermisos,"onUpdate:modelValue":e[19]||(e[19]=l=>o.dialogPermisos=l),persistent:""},{default:a(()=>[s(_,{style:{"min-width":"420px"}},{default:a(()=>[s(k,{class:"q-pb-none row items-center text-bold"},{default:a(()=>[f(" Permisos de "+b(o.user.username)+" ",1),s(A),s(d,{icon:"close",flat:"",round:"",dense:"",onClick:e[16]||(e[16]=l=>o.dialogPermisos=!1)})]),_:1}),s(k,{class:"q-pt-none"},{default:a(()=>[s(v,{modelValue:o.permFilter,"onUpdate:modelValue":e[17]||(e[17]=l=>o.permFilter=l),dense:"",outlined:"",placeholder:"Filtrar permisos...",class:"q-mb-sm"},{append:a(()=>[s(g,{name:"search"})]),_:1},8,["modelValue"]),s(G,{dense:"",bordered:""},{default:a(()=>[(i(!0),w(D,null,U(t.filteredPermissions,l=>(i(),n(C,{key:l.id},{default:a(()=>[s(m,null,{default:a(()=>[f(b(l.name),1)]),_:2},1024),s(m,{side:""},{default:a(()=>[s(S,{modelValue:l.checked,"onUpdate:modelValue":u=>l.checked=u},null,8,["modelValue","onUpdate:modelValue"])]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1}),s(B,{align:"right"},{default:a(()=>[s(d,{color:"negative",label:"Cancelar",onClick:e[18]||(e[18]=l=>o.dialogPermisos=!1),"no-caps":"",loading:o.loading},null,8,["loading"]),s(d,{color:"primary",label:"Guardar",onClick:t.permisosPost,"no-caps":"",loading:o.loading},null,8,["onClick","loading"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const be=E(J,[["render",$]]);export{be as default};
