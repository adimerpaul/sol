import{Q as h}from"./QSpace-CRJFh_fq.js";import{_ as S,c as _,o as u,w as n,b as l,a as t,Q as v,e as m,f as d,af as p,d as x,a9 as y,aa as V,ab as k,ac as q,t as r,a8 as g,h as D,ah as Q}from"./index-D17d9CED.js";import{Q as A}from"./QBadge-CfV2PV27.js";import{c as I,Q as N,b as C,a as w}from"./QList-DtAzkZzK.js";import{Q as U}from"./QSelect-CvCEXiBv.js";import{Q as B}from"./QPage-Mqie5rLH.js";import"./format-C2NjPuPn.js";import"./position-engine-DqQ8RByf.js";const L={name:"MovimientosAlmacenInsumosForm",data(){const s=new Date().toISOString().substr(0,10);return{loading:!1,search:"",almacenes:[],insumos:[],carrito:[],qtyDlg:!1,current:null,form:{insumo_id:null,cantidad:null,costo:null},payDlg:!1,movimiento:{fecha:s,nota:""},keyCounter:1}},computed:{filteredAlmacenes(){const s=(this.search||"").toLowerCase();return s?this.almacenes.filter(e=>String(e.nombre||"").toLowerCase().includes(s)||String(e.unidad||"").toLowerCase().includes(s)||String(e.descripcion||"").toLowerCase().includes(s)):this.almacenes},insumosOptions(){return this.insumos.map(s=>({id:s.id,label:`${s.nombre} (${s.unidad})`}))},total(){return this.carrito.reduce((s,e)=>{const c=Number(e.cantidad||0),f=Number(e.costo||0);return s+c*f},0)}},mounted(){this.almacenesGet(),this.insumosGet()},methods:{to2(s){return Number(s||0).toLocaleString("es-BO",{minimumFractionDigits:2,maximumFractionDigits:2})},money(s){return this.to2(s)},async almacenesGet(){this.loading=!0;try{const s=await this.$axios.get("almacenes");this.almacenes=Array.isArray(s.data)?s.data:[]}catch{this.$alert?.error?.("No se pudo cargar los insumos de almacén")}finally{this.loading=!1}},async insumosGet(){try{const s=await this.$axios.get("insumos");this.insumos=Array.isArray(s.data)?s.data:[]}catch{this.$alert?.error?.("No se pudo cargar los insumos de despensa")}},openQtyDialog(s){this.current=s,this.form={insumo_id:null,cantidad:1,costo:Number(s.costo||0)},this.qtyDlg=!0},addToCart(){const s=Number(this.form.cantidad||0),e=Number(this.form.costo||0),c=this.form.insumo_id;if(!c||s<=0){this.$alert?.error?.("Seleccione insumo destino y cantidad válida");return}const f=this.insumos.find(i=>i.id===c);if(!f){this.$alert?.error?.("Insumo destino inválido");return}const a=this.keyCounter++;this.carrito.push({key:a,almacen_id:this.current.id,almacen_nombre:this.current.nombre,insumo_id:f.id,insumo_nombre:f.nombre,cantidad:s,costo:e}),this.qtyDlg=!1},removeFromCart(s){this.carrito=this.carrito.filter(e=>e.key!==s)},clearCart(){this.carrito=[]},openPayDialog(){if(!this.carrito.length){this.$alert?.error?.("No hay ítems en el movimiento");return}this.payDlg=!0},async saveMovimiento(){const s={fecha:this.movimiento.fecha,nota:this.movimiento.nota||null,detalles:this.carrito.map(e=>({almacen_id:e.almacen_id,insumo_id:e.insumo_id,cantidad:Number(e.cantidad||0),costo:Number(e.costo||0)}))};this.loading=!0;try{await this.$axios.post("movimientos-almacen-insumos",s),this.$alert?.success?.("Movimiento registrado"),this.payDlg=!1,this.carrito=[],this.movimiento.nota="",this.almacenesGet()}catch(e){const c=e.response?.data?.message||"No se pudo registrar el movimiento";this.$alert?.error?.(c)}finally{this.loading=!1}}}},M={class:"row q-col-gutter-sm"},F={class:"col-12 col-md-8"},G={class:"row items-center q-col-gutter-sm"},T={class:"col-12 col-md-6"},O={class:"col-12 col-md-6 text-right"},P={class:"q-mt-sm"},z=["onClick"],E={class:"row items-center q-px-sm q-py-xs"},R={class:"col-8"},j={class:"text-body1 text-weight-medium"},H={class:"text-caption text-grey"},J={class:"col-4 text-right"},K={key:0,class:"q-mt-md text-center text-grey"},W={class:"col-12 col-md-4"},X={class:"row q-col-gutter-xs q-mt-xs"},Y={class:"col-6"},Z={class:"col-6"},$={class:"text-bold text-primary"},ee={class:"q-mt-sm text-right text-subtitle1"},te={class:"text-subtitle1"},oe={class:"text-caption q-mb-xs"},se={class:"row q-col-gutter-sm"},le={class:"col-12 col-sm-6"},ae={class:"col-12"},ne={class:"q-mt-sm text-right text-subtitle1"};function ie(s,e,c,f,a,i){return u(),_(B,{class:"bg-grey-3 q-pa-sm"},{default:n(()=>[l("div",M,[l("div",F,[t(v,{flat:"",bordered:""},{default:n(()=>[t(m,{class:"q-pa-sm bg-blue-1 row items-center"},{default:n(()=>[e[12]||(e[12]=l("div",{class:"text-subtitle1 text-weight-bold"},"Almacén",-1)),t(h),t(d,{flat:"",dense:"",color:"primary",icon:"arrow_back",label:"Volver a movimientos","no-caps":"",to:{path:"/movimientos-almacen-insumos"}})]),_:1}),t(m,{class:"q-pa-sm"},{default:n(()=>[l("div",G,[l("div",T,[t(p,{modelValue:a.search,"onUpdate:modelValue":e[0]||(e[0]=o=>a.search=o),dense:"",outlined:"",placeholder:"Buscar en almacén (nombre, unidad, descripción)"},{prepend:n(()=>[t(x,{name:"search"})]),_:1},8,["modelValue"])]),l("div",O,[t(d,{flat:"",color:"primary",icon:"refresh",loading:a.loading,onClick:i.almacenesGet,label:"Actualizar","no-caps":""},null,8,["loading","onClick"])])]),l("div",P,[e[14]||(e[14]=l("div",{class:"row text-grey-7 q-pb-xs"},[l("div",{class:"col-8 text-caption text-weight-bold"},"Insumo almacén"),l("div",{class:"col-4 text-right text-caption text-weight-bold"},"Stock")],-1)),(u(!0),y(k,null,q(i.filteredAlmacenes,o=>(u(),y("div",{key:o.id,class:"q-py-xs q-mb-xs bg-grey-1 rounded-borders cursor-pointer",onClick:b=>i.openQtyDialog(o)},[l("div",E,[l("div",R,[l("div",j,r(o.nombre),1),l("div",H,r(o.unidad)+" — "+r(o.descripcion||"—"),1)]),l("div",J,[t(A,{color:"primary","text-color":"white",align:"middle"},{default:n(()=>[g(r(i.to2(o.stock))+" "+r(o.unidad),1)]),_:2},1024)])])],8,z))),128)),i.filteredAlmacenes.length?V("",!0):(u(),y("div",K,[t(x,{name:"inventory_2"}),e[13]||(e[13]=l("div",{class:"text-caption"},"Sin insumos de almacén para mostrar",-1))]))])]),_:1})]),_:1})]),l("div",W,[t(v,{flat:"",bordered:""},{default:n(()=>[t(m,{class:"q-pa-sm bg-amber-1 row items-center"},{default:n(()=>[e[15]||(e[15]=l("div",{class:"text-subtitle1 text-bold"},"Salida hacia Insumos",-1)),t(h),t(d,{dense:"",flat:"",color:"red",icon:"delete_sweep",label:"Limpiar","no-caps":"",onClick:i.clearCart},null,8,["onClick"])]),_:1}),t(m,{class:"q-pa-sm"},{default:n(()=>[t(I,{bordered:"",dense:"",class:"rounded-borders"},{default:n(()=>[(u(!0),y(k,null,q(a.carrito,o=>(u(),_(N,{key:o.key},{default:n(()=>[t(C,null,{default:n(()=>[t(w,{class:"text-bold"},{default:n(()=>[g(r(o.almacen_nombre)+" ",1),t(x,{name:"arrow_forward",size:"14px",class:"q-ml-xs"}),g(" "+r(o.insumo_nombre),1)]),_:2},1024),t(w,{caption:""},{default:n(()=>[l("div",X,[l("div",Y,[t(p,{modelValue:o.cantidad,"onUpdate:modelValue":b=>o.cantidad=b,modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Cantidad"},null,8,["modelValue","onUpdate:modelValue"])]),l("div",Z,[t(p,{modelValue:o.costo,"onUpdate:modelValue":b=>o.costo=b,modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Costo (Bs)"},null,8,["modelValue","onUpdate:modelValue"])])])]),_:2},1024)]),_:2},1024),t(C,{side:"",class:"text-right"},{default:n(()=>[l("div",$,r(i.money(o.cantidad*o.costo)),1),t(d,{dense:"",flat:"",round:"",icon:"delete",color:"red",onClick:b=>i.removeFromCart(o.key)},null,8,["onClick"])]),_:2},1024)]),_:2},1024))),128)),a.carrito.length?V("",!0):(u(),_(N,{key:0},{default:n(()=>[t(C,null,{default:n(()=>[t(w,{caption:""},{default:n(()=>[...e[16]||(e[16]=[g("Sin ítems en la salida",-1)])]),_:1})]),_:1})]),_:1}))]),_:1}),l("div",ee,[e[17]||(e[17]=l("b",null,"Total:",-1)),g(" "+r(i.money(i.total))+" Bs ",1)]),t(d,{class:"q-mt-md full-width",color:"indigo",icon:"sync_alt",label:"Registrar movimiento",disable:!a.carrito.length,loading:a.loading,"no-caps":"",onClick:i.openPayDialog},null,8,["disable","loading","onClick"])]),_:1})]),_:1})])]),t(D,{modelValue:a.qtyDlg,"onUpdate:modelValue":e[6]||(e[6]=o=>a.qtyDlg=o)},{default:n(()=>[t(v,{style:{width:"480px","max-width":"90vw"}},{default:n(()=>[t(m,{class:"row items-center q-pb-none"},{default:n(()=>[l("div",te,"Desde almacén: "+r(a.current?.nombre),1),t(h),t(d,{flat:"",round:"",dense:"",icon:"close",onClick:e[1]||(e[1]=o=>a.qtyDlg=!1)})]),_:1}),t(m,{class:"q-pt-none"},{default:n(()=>[l("div",oe," Unidad: "+r(a.current?.unidad)+" | Stock actual: "+r(i.to2(a.current?.stock)),1),t(U,{modelValue:a.form.insumo_id,"onUpdate:modelValue":e[2]||(e[2]=o=>a.form.insumo_id=o),options:i.insumosOptions,dense:"",outlined:"",label:"Insumo destino (despensa)","option-value":"id","option-label":"label","emit-value":"","map-options":"",class:"q-mb-sm"},null,8,["modelValue","options"]),t(p,{modelValue:a.form.cantidad,"onUpdate:modelValue":e[3]||(e[3]=o=>a.form.cantidad=o),modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Cantidad",class:"q-mb-sm"},null,8,["modelValue"]),t(p,{modelValue:a.form.costo,"onUpdate:modelValue":e[4]||(e[4]=o=>a.form.costo=o),modelModifiers:{number:!0},type:"number",step:"0.01",dense:"",outlined:"",label:"Costo (Bs)"},null,8,["modelValue"])]),_:1}),t(Q,{align:"right"},{default:n(()=>[t(d,{flat:"",label:"Cancelar",color:"negative","no-caps":"",onClick:e[5]||(e[5]=o=>a.qtyDlg=!1)}),t(d,{label:"Agregar",color:"primary","no-caps":"",onClick:i.addToCart},null,8,["onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"]),t(D,{modelValue:a.payDlg,"onUpdate:modelValue":e[11]||(e[11]=o=>a.payDlg=o)},{default:n(()=>[t(v,{style:{width:"540px","max-width":"95vw"}},{default:n(()=>[t(m,{class:"row items-center q-pb-none"},{default:n(()=>[e[18]||(e[18]=l("div",{class:"text-subtitle1"},"Confirmar movimiento Almacén → Insumos",-1)),t(h),t(d,{flat:"",round:"",dense:"",icon:"close",onClick:e[7]||(e[7]=o=>a.payDlg=!1)})]),_:1}),t(m,{class:"q-pt-none"},{default:n(()=>[l("div",se,[l("div",le,[t(p,{modelValue:a.movimiento.fecha,"onUpdate:modelValue":e[8]||(e[8]=o=>a.movimiento.fecha=o),label:"Fecha",type:"date",dense:"",outlined:""},null,8,["modelValue"])]),l("div",ae,[t(p,{modelValue:a.movimiento.nota,"onUpdate:modelValue":e[9]||(e[9]=o=>a.movimiento.nota=o),label:"Nota",type:"textarea",autogrow:"",dense:"",outlined:""},null,8,["modelValue"])])]),l("div",ne,[e[19]||(e[19]=l("b",null,"Total:",-1)),g(" "+r(i.money(i.total))+" Bs ",1)])]),_:1}),t(Q,{align:"right"},{default:n(()=>[t(d,{flat:"",color:"negative",label:"Cancelar","no-caps":"",onClick:e[10]||(e[10]=o=>a.payDlg=!1)}),t(d,{color:"positive",label:"Guardar","no-caps":"",loading:a.loading,onClick:i.saveMovimiento},null,8,["loading","onClick"])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const be=S(L,[["render",ie]]);export{be as default};
