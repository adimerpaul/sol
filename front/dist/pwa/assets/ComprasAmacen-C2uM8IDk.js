import{_ as Q,c as p,o as b,w as a,a as l,Q as f,e as c,b as t,af as g,d as m,f as h,t as i,P as _,aa as k,a8 as d,ad as v,h as q}from"./index-D17d9CED.js";import{Q as N}from"./format-C2NjPuPn.js";import{Q as C}from"./QTd-D0V8Af-v.js";import{c as A,Q as w,b as u}from"./QList-DtAzkZzK.js";import{Q as B}from"./QBtnDropdown-DZ9Zwjea.js";import{Q as V}from"./QTable-ndNxYlyN.js";import{Q as D}from"./QSpace-CRJFh_fq.js";import{Q as F}from"./QPage-Mqie5rLH.js";import{C as x}from"./ClosePopup-DI1WlcTZ.js";import"./position-engine-DqQ8RByf.js";import"./QSelect-CvCEXiBv.js";const I={name:"ComprasAlmacenIndex",data(){const o=new Date().toISOString().substr(0,10);return{f:{ini:o,fin:o,q:""},loading:!1,rows:[],dlgVer:!1,compra:null,columns:[{name:"id",label:"#",field:"id",align:"left",sortable:!0},{name:"opciones",label:"Opciones",field:"opciones",align:"center"},{name:"fecha",label:"Fecha",field:"fecha",align:"left",sortable:!0},{name:"proveedor",label:"Proveedor",field:"proveedor",align:"left"},{name:"detalles_count",label:"Ítems",field:"detalles_count",align:"right"},{name:"total",label:"Total (Bs)",field:"total",align:"right",format:e=>Number(e||0).toFixed(2),sortable:!0},{name:"estado",label:"Estado",field:"estado",align:"left",sortable:!0}],colsDetalles:[{name:"almacen",label:"Insumo almacén",align:"left",field:e=>e.almacen&&e.almacen.nombre?e.almacen.nombre:""},{name:"unidad",label:"Unidad",align:"left",field:e=>e.almacen&&e.almacen.unidad?e.almacen.unidad:""},{name:"cantidad",label:"Cantidad",align:"right",field:"cantidad"},{name:"costo",label:"Costo",align:"right",field:e=>Number(e.costo||0).toFixed(2)},{name:"subtotal",label:"Subtotal",align:"right",field:e=>Number(e.subtotal||0).toFixed(2)}]}},computed:{totalCompras(){return this.rows.reduce((o,e)=>o+Number(e.total||0),0)},totalAnuladas(){return this.rows.filter(o=>o.estado==="ANULADO").reduce((o,e)=>o+Number(e.total||0),0)},totalVigentes(){return this.rows.filter(o=>o.estado!=="ANULADO").reduce((o,e)=>o+Number(e.total||0),0)}},mounted(){this.fetch()},methods:{money(o){return Number(o||0).toLocaleString("es-BO",{minimumFractionDigits:2,maximumFractionDigits:2})},async fetch(){this.loading=!0;try{const o=await this.$axios.post("compras-almacen/report",{fechaInicio:this.f.ini,fechaFin:this.f.fin,q:this.f.q});this.rows=o.data}catch(o){this.$alert?.error?.(o.response?.data?.message||"No se pudo cargar las compras")}finally{this.loading=!1}},async ver(o){try{const e=await this.$axios.get(`compras-almacen/${o}`);this.compra=e.data,this.dlgVer=!0}catch{this.$alert?.error?.("No se pudo abrir la compra")}},anular(o){this.$alert.dialog("¿Anular la compra de almacén? Esto revertirá el stock.").onOk(async()=>{this.loading=!0;try{await this.$axios.put(`compras-almacen/${o}/anular`),this.$alert?.success?.("Compra anulada"),this.fetch()}catch(e){this.$alert?.error?.(e.response?.data?.message||"No se pudo anular")}finally{this.loading=!1}})},pdf(o){const e=this.$axios.defaults.baseURL||"";window.open(`${e}/compras-almacen/${o}/pdf`,"_blank")}}},S={class:"row items-end q-col-gutter-sm"},U={class:"col-12 col-md-3"},O={class:"col-12 col-md-3"},L={class:"col-12 col-md-3"},P={class:"col-12 col-md-3 text-right"},T={class:"row q-col-gutter-sm"},z={class:"col-xs-12 col-md-4"},E={class:"text-h6 text-weight-bold"},R={class:"col-xs-12 col-md-4"},j={class:"text-h6 text-weight-bold"},G={class:"col-xs-12 col-md-4"},H={class:"text-h6 text-weight-bold"},J={class:"full-width row flex-center text-grey q-gutter-sm"},K={class:"text-subtitle1"},M={class:"q-mb-sm"},W={class:"text-right text-subtitle1 q-mt-sm"};function X(o,e,Y,Z,s,n){return b(),p(F,{class:"q-pa-md bg-grey-3"},{default:a(()=>[l(f,{flat:"",bordered:"",class:"q-pa-sm"},{default:a(()=>[l(c,{class:"q-pa-sm"},{default:a(()=>[t("div",S,[t("div",U,[l(g,{modelValue:s.f.ini,"onUpdate:modelValue":e[0]||(e[0]=r=>s.f.ini=r),label:"Fecha inicio",type:"date",dense:"",outlined:""},null,8,["modelValue"])]),t("div",O,[l(g,{modelValue:s.f.fin,"onUpdate:modelValue":e[1]||(e[1]=r=>s.f.fin=r),label:"Fecha fin",type:"date",dense:"",outlined:""},null,8,["modelValue"])]),t("div",L,[l(g,{modelValue:s.f.q,"onUpdate:modelValue":e[2]||(e[2]=r=>s.f.q=r),label:"Buscar (proveedor / nota / estado)",dense:"",outlined:"",clearable:""},{append:a(()=>[l(m,{name:"search"})]),_:1},8,["modelValue"])]),t("div",P,[l(h,{color:"primary",label:"Nueva Compra",icon:"add_shopping_cart","no-caps":"",class:"q-mr-sm",to:{path:"/compras-almacen/nueva"}}),l(h,{color:"indigo",label:"Buscar",icon:"search","no-caps":"",loading:s.loading,onClick:n.fetch},null,8,["loading","onClick"])])])]),_:1}),l(c,{class:"q-pt-none"},{default:a(()=>[t("div",T,[t("div",z,[l(f,{flat:"",bordered:"",class:"bg-green-1"},{default:a(()=>[l(c,{class:"row items-center"},{default:a(()=>[l(m,{name:"trending_up",color:"green",size:"md",class:"q-mr-sm"}),t("div",null,[e[5]||(e[5]=t("div",{class:"text-caption"},"Compras (Bs)",-1)),t("div",E,i(n.money(n.totalCompras)),1)])]),_:1})]),_:1})]),t("div",R,[l(f,{flat:"",bordered:"",class:"bg-red-1"},{default:a(()=>[l(c,{class:"row items-center"},{default:a(()=>[l(m,{name:"block",color:"red",size:"md",class:"q-mr-sm"}),t("div",null,[e[6]||(e[6]=t("div",{class:"text-caption"},"Anuladas (Bs)",-1)),t("div",j,i(n.money(n.totalAnuladas)),1)])]),_:1})]),_:1})]),t("div",G,[l(f,{flat:"",bordered:"",class:"bg-blue-1"},{default:a(()=>[l(c,{class:"row items-center"},{default:a(()=>[l(m,{name:"check_circle",color:"blue",size:"md",class:"q-mr-sm"}),t("div",null,[e[7]||(e[7]=t("div",{class:"text-caption"},"Vigentes (Bs)",-1)),t("div",H,i(n.money(n.totalVigentes)),1)])]),_:1})]),_:1})])])]),_:1}),l(c,{class:"q-pt-none"},{default:a(()=>[l(V,{rows:s.rows,columns:s.columns,"row-key":"id",flat:"",bordered:"",dense:"","rows-per-page-options":[0],loading:s.loading,"hide-bottom":"","binary-state-sort":""},{"body-cell-estado":a(r=>[l(C,{props:r},{default:a(()=>[l(N,{dense:"",square:"",color:r.row.estado==="ANULADO"?"negative":"primary","text-color":"white"},{default:a(()=>[d(i(r.row.estado),1)]),_:2},1032,["color"])]),_:2},1032,["props"])]),"body-cell-opciones":a(r=>[l(C,{props:r},{default:a(()=>[l(B,{dense:"",icon:"more_vert",label:"Compra #"+r.row.id,"no-caps":"",size:"10px",color:"primary"},{default:a(()=>[l(A,null,{default:a(()=>[_((b(),p(w,{clickable:"",onClick:y=>n.ver(r.row.id)},{default:a(()=>[l(u,{avatar:""},{default:a(()=>[l(m,{name:"visibility"})]),_:1}),l(u,null,{default:a(()=>[d("Ver compra #"+i(r.row.id),1)]),_:2},1024)]),_:2},1032,["onClick"])),[[v],[x]]),_((b(),p(w,{clickable:"",onClick:y=>n.pdf(r.row.id)},{default:a(()=>[l(u,{avatar:""},{default:a(()=>[l(m,{name:"picture_as_pdf",color:"amber-10"})]),_:1}),l(u,null,{default:a(()=>[...e[8]||(e[8]=[d("Ver PDF",-1)])]),_:1})]),_:1},8,["onClick"])),[[v],[x]]),r.row.estado==="ACTIVO"?_((b(),p(w,{key:0,clickable:"",onClick:y=>n.anular(r.row.id)},{default:a(()=>[l(u,{avatar:""},{default:a(()=>[l(m,{name:"block",color:"negative"})]),_:1}),l(u,null,{default:a(()=>[...e[9]||(e[9]=[d("Anular compra",-1)])]),_:1})]),_:1},8,["onClick"])),[[v],[x]]):k("",!0)]),_:2},1024)]),_:2},1032,["label"])]),_:2},1032,["props"])]),"no-data":a(()=>[t("div",J,[l(m,{name:"inbox"}),e[10]||(e[10]=t("span",null,"Sin compras registradas",-1))])]),_:1},8,["rows","columns","loading"])]),_:1})]),_:1}),l(q,{modelValue:s.dlgVer,"onUpdate:modelValue":e[4]||(e[4]=r=>s.dlgVer=r)},{default:a(()=>[l(f,{style:{"min-width":"720px"}},{default:a(()=>[l(c,{class:"row items-center q-pb-none"},{default:a(()=>[t("div",K," Compra almacén #"+i(s.compra?s.compra.id:""),1),l(D),l(h,{flat:"",round:"",dense:"",icon:"close",onClick:e[3]||(e[3]=r=>s.dlgVer=!1)})]),_:1}),l(c,{class:"q-pt-none"},{default:a(()=>[t("div",M,[t("div",null,[e[11]||(e[11]=t("b",null,"Fecha:",-1)),d(" "+i(s.compra?.fecha),1)]),t("div",null,[e[12]||(e[12]=t("b",null,"Proveedor:",-1)),d(" "+i(s.compra?.proveedor||"—"),1)]),t("div",null,[e[13]||(e[13]=t("b",null,"Estado:",-1)),d(" "+i(s.compra?.estado),1)]),t("div",null,[e[14]||(e[14]=t("b",null,"Nota:",-1)),d(" "+i(s.compra?.nota||"—"),1)])]),l(V,{rows:s.compra?.detalles||[],columns:s.colsDetalles,dense:"",flat:"",bordered:"","rows-per-page-options":[0],"hide-bottom":""},null,8,["rows","columns"]),t("div",W,[e[15]||(e[15]=t("b",null,"Total:",-1)),d(" "+i(n.money(s.compra?.total||0))+" Bs ",1)])]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:1})}const ce=Q(I,[["render",X]]);export{ce as default};
